<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agora Call</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #c9d6ff, #e2e2e2);
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    h1 {
      margin-top: 20px;
      color: #333;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .video-container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .video-box {
      width: 400px;
      height: 300px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      backdrop-filter: blur(12px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      overflow: hidden;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .controls {
      margin-top: 30px;
      display: flex;
      gap: 15px;
    }

    button {
      padding: 12px 20px;
      border: none;
      border-radius: 30px;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(10px);
      font-weight: bold;
      color: #333;
      cursor: pointer;
      transition: 0.2s ease-in-out;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    }

    button:hover {
      background: rgba(255, 255, 255, 0.5);
    }
  </style>
</head>
<body>
  <h1>🎥 Agora Secure Call</h1>
  <div id="status">מחכה להתחברות...</div>

  <div class="video-container">
    <div id="local-player" class="video-box"></div>
    <div id="remote-player" class="video-box"></div>
  </div>

  <div class="controls">
    <button id="btn-mic">🔇 Mute</button>
    <button id="btn-cam">📷 Turn Off Camera</button>
    <button id="btn-leave">🚪 Leave</button>
  </div>

  <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
  <script>
    let APP_ID = "";
    const CHANNEL_NAME = "test-room";
    let client;
    let microphoneTrack, cameraTrack;
    let micMuted = false;
    let camMuted = false;

    window.onload = () => {
      fetch('/appId')
        .then(res => res.json())
        .then(data => {
          APP_ID = data.appId;
          startCall();
        });
    };

    async function startCall() {
      client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

      document.getElementById("status").innerText = "מתחבר לערוץ...";

      const tokenRes = await fetch(`/rte-token?channelName=${CHANNEL_NAME}`);
      const tokenData = await tokenRes.json();

      await client.join(APP_ID, CHANNEL_NAME, tokenData.rtcToken, null);

      document.getElementById("status").innerText = "✅ מחובר";

      [microphoneTrack, cameraTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();

      cameraTrack.play("local-player");
      await client.publish([microphoneTrack, cameraTrack]);

      // 🧠 כאשר משתמש אחר מפרסם מדיה
      client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);

        if (mediaType === 'video') {
          user.videoTrack.play("remote-player");
        }
        if (mediaType === 'audio') {
          user.audioTrack.play();
        }
      });

      // 🧠 אם אנחנו מתחברים באיחור – נתחבר למדיה שכבר משודרת
      client.remoteUsers.forEach(async (user) => {
        await client.subscribe(user, "video");
        user.videoTrack?.play("remote-player");

        await client.subscribe(user, "audio");
        user.audioTrack?.play();
      });
    }

    document.getElementById("btn-mic").onclick = () => {
      micMuted = !micMuted;
      if (micMuted) {
        microphoneTrack.setEnabled(false);
        document.getElementById("btn-mic").innerText = "🎤 Unmute";
      } else {
        microphoneTrack.setEnabled(true);
        document.getElementById("btn-mic").innerText = "🔇 Mute";
      }
    };

    document.getElementById("btn-cam").onclick = () => {
      camMuted = !camMuted;
      if (camMuted) {
        cameraTrack.setEnabled(false);
        document.getElementById("btn-cam").innerText = "🎥 Turn On Camera";
      } else {
        cameraTrack.setEnabled(true);
        document.getElementById("btn-cam").innerText = "📷 Turn Off Camera";
      }
    };

    document.getElementById("btn-leave").onclick = async () => {
      await client.leave();
      microphoneTrack && microphoneTrack.stop();
      cameraTrack && cameraTrack.stop();
      document.getElementById("status").innerText = "👋 יצאת מהשיחה";
      document.getElementById("local-player").innerHTML = "";
      document.getElementById("remote-player").innerHTML = "";
    };
  </script>
</body>
</html>
