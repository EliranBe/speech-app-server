<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agora Secure Call</title>
  <style>
    .video-container {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }
    .video-box {
      width: 400px;
      height: 300px;
      background-color: #000;
    }
    video {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <h1>ğŸ¥ ×‘×“×™×§×ª Agora SDK</h1>
  <div id="status">××—×›×” ×œ×”×ª×—×‘×¨×•×ª...</div>

  <div class="video-container">
    <div id="local-player" class="video-box"></div>
    <div id="remote-player" class="video-box"></div>
  </div>

  <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N-4.20.0.js"></script>
  <script>
    let APP_ID = "";
    const CHANNEL_NAME = "test-room";
    let client;

    window.onload = () => {
      fetch('/appId')
        .then(res => res.json())
        .then(data => {
          APP_ID = data.appId;
          startCall();
        });
    };

    async function startCall() {
      client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

      document.getElementById("status").innerText = "××ª×—×‘×¨ ×œ×¢×¨×•×¥...";

      const tokenRes = await fetch(`/rte-token?channelName=${CHANNEL_NAME}`);
      const tokenData = await tokenRes.json();

      await client.join(APP_ID, CHANNEL_NAME, tokenData.rtcToken, null);

      document.getElementById("status").innerText = "âœ… ××—×•×‘×¨";

      // ×™×¦×™×¨×ª ×¢×¨×•×¦×™× ×œ××™×§×¨×•×¤×•×Ÿ ×•××¦×œ××”
      const [microphoneTrack, cameraTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();

      // ×”×¦×’×ª ×”×•×•×™×“××• ×”××§×•××™
      cameraTrack.play("local-player");

      // ×¤×¨×¡×•× ×”×•×™×“××• ×•×”×©××¢
      await client.publish([microphoneTrack, cameraTrack]);

      // ×”×¦×’×ª ××©×ª×ª×£ ××¨×•×—×§
      client.on("user-published", async (user, mediaType) => {
        await client.subscribe(user, mediaType);

        if (mediaType === 'video') {
          user.videoTrack.play("remote-player");
        }
        if (mediaType === 'audio') {
          user.audioTrack.play();
        }
      });

      client.on("user-unpublished", (user) => {
        console.log("ğŸ‘‹ ××©×ª××© ×¢×–×‘:", user.uid);
        // × ×™×ª×Ÿ ×œ× ×§×•×ª ××ª ×”××œ×× ×˜ ×©×œ ×”××©×ª××© ×©×™×¦×
      });
    }
  </script>
</body>
</html>
