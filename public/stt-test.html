<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STT Test - Opus 48kHz</title>
  <style>
    body.recording { background-color: #fffae6; }
    #transcript { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: auto; }
    #status { margin-top: 10px; font-weight: bold; color: #444; }
  </style>
</head>
<body>
  <h1>🎤 STT Microphone Test (Opus 48kHz)</h1>
  <button id="start">Start</button>

  <div id="captions"></div>
  <div id="status"></div>

<script>
let ws;
let mediaRecorder;
let stream;
let reconnectTimeout = null;

const captions = window.document.getElementById('captions');
const statusDiv = window.document.getElementById('status');
const startBtn = window.document.getElementById('start');

  let microphone;
let socket;
let isRunning = false; // מצב האם פועל או לא

startBtn.addEventListener("click", async () => {
  if (!isRunning) {
    // ▶️ התחלה
    socket = new WebSocket(`wss://${window.location.host}`);

    socket.addEventListener("open", async () => {
      console.log("✅ connected to server");
      try {
        microphone = await getMicrophone();
        await openMicrophone(microphone, socket);
        startBtn.textContent = "STOP"; // שינוי טקסט בכפתור
        isRunning = true;
      } catch (error) {
        console.error("⚠️ error opening microphone:", error);
      }
    });

    socket.addEventListener("message", (event) => {
      if (event.data === "") return;
      let data;
      try {
        data = JSON.parse(event.data);
      } catch (e) {
        console.error("⚠️ Failed to parse JSON:", e);
        return;
      }
      if (data && data.channel && data.channel.alternatives[0].transcript !== "") {
        const span = document.createElement('div');
        span.textContent = data.channel.alternatives[0].transcript;
        captions.appendChild(span);
      }
    });

    socket.addEventListener("close", () => {
      console.log("❌ disconnected from server");
    });

  } else {
    // ⏹️ עצירה
    await closeMicrophone(microphone);
    microphone = undefined;
    if (socket && socket.readyState === WebSocket.OPEN) {
      socket.close();
    }
    startBtn.textContent = "START"; // שינוי טקסט בכפתור
    isRunning = false;
  }
});

async function getMicrophone() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    return new MediaRecorder(stream, { mimeType: "audio/webm" });
  } catch (error) {
    console.error("⚠️ error accessing microphone:", error);
    throw error;
  }
} 
  
async function openMicrophone(microphone, socket) {
  return new Promise((resolve) => {
    microphone.onstart = () => {
      console.log("🎙️ microphone opened");
      document.body.classList.add("recording");
      resolve();
    };

    microphone.onstop = () => {
      console.log("🛑 Microphone closed");
      document.body.classList.remove("recording");
        if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
        console.log("🔌 WebSocket closed");
  }
    };

    microphone.ondataavailable = (event) => {
      console.log("🎙️ microphone data received");
      if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
        socket.send(event.data);
      }
    };

 microphone.start(1000); // שולח כל 1000 ms
  });
}

async function closeMicrophone(microphone) {
  console.log("🛑 Recording stopped");
  microphone.stop();
}

</script>

</body>
</html>
