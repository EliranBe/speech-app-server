<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STT Test - Opus 48kHz</title>
  <style>
    body.recording { background-color: #fffae6; }
    #transcript { white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; height: 150px; overflow-y: auto; }
    #status { margin-top: 10px; font-weight: bold; color: #444; }
  </style>
</head>
<body>
  <h1>üé§ STT Microphone Test (Opus 48kHz)</h1>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>

  <div id="captions"></div>
  <div id="status"></div>

<script>
let ws;
let mediaRecorder;
let stream;
let reconnectTimeout = null;

const captions = window.document.getElementById('captions');
const statusDiv = window.document.getElementById('status');
const startBtn = window.document.getElementById('start');
const stopBtn = window.document.getElementById('stop');

async function getMicrophone() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    return new MediaRecorder(stream, { mimeType: "audio/webm" });
  } catch (error) {
    console.error("‚ö†Ô∏è error accessing microphone:", error);
    throw error;
  }
} 
  
async function openMicrophone(microphone, socket) {
  return new Promise((resolve) => {
    microphone.onstart = () => {
      console.log("üéôÔ∏è microphone opened");
      document.body.classList.add("recording");
      resolve();
    };

    microphone.onstop = () => {
      console.log("üõë Microphone closed");
      document.body.classList.remove("recording");
        if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
        console.log("üîå WebSocket closed");
  }
    };

    microphone.ondataavailable = (event) => {
      console.log("üéôÔ∏è microphone data received");
      if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
        socket.send(event.data);
      }
    };

 microphone.start(1000); // ◊©◊ï◊ú◊ó ◊õ◊ú 1000 ms
  });
}

async function closeMicrophone(microphone) {
  console.log("üõë Recording stopped");
  microphone.stop();
}

  const socket = new WebSocket(`wss://${window.location.host}`);

async function start(socket) {
  const listenButton = document.querySelector("#start");
  let microphone; 
     
  console.log("waiting to open microphone");

  listenButton.addEventListener("click", async () => {
     if (!microphone) {
      try {
        microphone = await getMicrophone();
        await openMicrophone(microphone, socket);
      } catch (error) {
        console.error("‚ö†Ô∏è error opening microphone:", error);
      }
    } else {
      await closeMicrophone(microphone);
      microphone = undefined;
    }
  });
}

  socket.addEventListener("open", async () => {
    console.log("‚úÖ connected to server");
    await start(socket);
  });

  socket.addEventListener("message", (event) => {
    if (event.data === "") {
      return;
    }
    
    let data;
    try {
      data = JSON.parse(event.data);
    } catch (e) {
      console.error("‚ö†Ô∏è Failed to parse JSON:", e);
      return;
    }
  
    if (data && data.channel && data.channel.alternatives[0].transcript !== "" && data.channel.is_final) {
        const newText = data.channel.alternatives[0].transcript;
        const span = document.createElement('div');
        span.textContent = newText;
        captions.appendChild(span);
    }
  });

  socket.addEventListener("close", () => {
    console.log("‚ùå disconnected from server");
  });

 
</script>

</body>
</html>
