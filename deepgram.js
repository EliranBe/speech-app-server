// deepgram.js
const { WebSocketServer } = require('ws');

const deepgramApiKey = process.env.DEEPGRAM_API_KEY;
if (!deepgramApiKey) {
  throw new Error('Missing DEEPGRAM_API_KEY in environment variables');
}

// ◊§◊ï◊™◊ó WebSocket ◊ô◊©◊ô◊® ◊ú÷æDeepgram API:
function startWebSocketServer(server) {
  const wss = new WebSocketServer({ server });

  wss.on('connection', (wsClient) => {
    console.log('üîó Client connected');

    // ◊§◊ï◊™◊ó WS ◊ô◊©◊ô◊® ◊ú-Deepgram ◊¢◊ù ◊î◊§◊®◊û◊ò◊®◊ô◊ù ◊î◊ì◊®◊ï◊©◊ô◊ù:
    const deepgramSocket = new require('ws')('wss://api.deepgram.com/v1/listen?punctuate=true&interim_results=true&language=en&encoding=linear16&sample_rate=16000', {
      headers: {
        Authorization: `Token ${deepgramApiKey}`,
      },
    });

    deepgramSocket.on('open', () => {
      console.log('‚úÖ Connected to Deepgram');

      // ◊õ◊©◊û◊ß◊ë◊ú◊ô◊ù ◊î◊ï◊ì◊¢◊ï◊™ ◊û÷æDeepgram:
      deepgramSocket.on('message', (data) => {
        try {
          const msg = JSON.parse(data);
          console.log('üì• Deepgram message:', msg);

          if (wsClient.readyState === wsClient.OPEN) {
            wsClient.send(data); // ◊©◊ï◊ú◊ó ◊ú◊ú◊ß◊ï◊ó ◊ô◊©◊ô◊®◊ï◊™ ◊ê◊™ ◊õ◊ú ◊î◊î◊ï◊ì◊¢◊î
          }
        } catch (e) {
          console.error('‚ùå Error parsing Deepgram message:', e);
        }
      });

      deepgramSocket.on('error', (e) => {
        console.error('‚ùå Deepgram WebSocket error:', e);
        wsClient.close();
      });

      deepgramSocket.on('close', () => {
        console.log('üîå Deepgram WebSocket closed');
        wsClient.close();
      });
    });

    deepgramSocket.on('error', (e) => {
      console.error('‚ùå Failed to connect Deepgram WS:', e);
      wsClient.close();
    });

    wsClient.on('message', (msg) => {
      // msg ◊î◊ï◊ê Buffer ◊©◊ú raw PCM 16bit 16kHz
      if (deepgramSocket.readyState === deepgramSocket.OPEN) {
        deepgramSocket.send(msg);
      }
    });

    wsClient.on('close', () => {
      console.log('‚ùå Client disconnected');
      if (deepgramSocket.readyState === deepgramSocket.OPEN) {
        deepgramSocket.close();
      }
    });

    wsClient.on('error', (e) => {
      console.error('‚ùå Client WebSocket error:', e);
      try {
        wsClient.close();
      } catch {}
    });
  });
}

module.exports = startWebSocketServer;
